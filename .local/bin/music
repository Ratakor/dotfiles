#!/bin/sh
#                                                         ..      ...
#    author: ratakor <ratakor@disroot.org>             :~"8888x :"%888x
#                                                     8    8888Xf  8888>
#    created: Sat, 06 May 2023 18:44:52 +0200        X88x. ?8888k  8888X
#    updated: Sat, 06 May 2023 20:11:33 +0200        '8888L'8888X  '%88X
#                                                     "888X 8888X:xnHH(``
#    description:                                       ?8~ 8888X X8888
#    simple music selector with dmenu that uses and   -~`   8888> X8888
#    interacts with mpv, have a look at musiccmd,     :H8x  8888  X8888
#    dwmblocks/sb_music and .local/etc/mpv/music ;)   8888> 888~  X8888
#                                                     48"` '8*~   `8888!`
#    shellcheck disable=SC2012 #                        ^-==""      `""

MUSICDIR="${XDG_MUSIC_DIR:-$HOME/Music}"

if [ "$1" = "--shuffle" ]; then
	SHUFFLE=yes
	shift
fi

MUSIC="${1:-$MUSICDIR/$(ls "$MUSICDIR" | dmenu -i -p "Play ")}"
SCRIPT="${XDG_CONFIG_HOME:-$HOME/.config}/mpv/music/local.lua"

if [ "$MUSIC" = "$MUSICDIR/urls" ]; then
	MUSIC="$(cat "$MUSICDIR/urls/$(ls "$MUSICDIR/urls" | dmenu -i -p "Play ")")"
	SCRIPT="${XDG_CONFIG_HOME:-$HOME/.config}/mpv/music/online.lua"
fi

[ "$MUSIC" = "$MUSICDIR/" ] || [ -z "$MUSIC" ] && exit 1

if [ -z "$SHUFFLE" ] && [ -d "$MUSIC" ] || printf '%s' "$MUSIC" | grep -q playlist; then
	SHUFFLE="$(printf 'yes\nno' | dmenu -i -p 'Shuffle?')"
	[ -z "$SHUFFLE" ] && exit 1
fi

printf 'stop\n' | socat - /tmp/mpvsocket 2> /dev/null
mpv --vid=no --input-ipc-server=/tmp/mpvsocket --loop-playlist\
	--ytdl-format="wv*+ba" --script="$SCRIPT" --shuffle="$SHUFFLE" "$MUSIC"
