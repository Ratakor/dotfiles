#!/bin/sh
# simple music selector with dmenu that uses and interacts with mpv
# shellcheck disable=SC2012
MUSICDIR="${XDG_MUSIC_DIR:-$HOME/Music}"

MUSIC="${1:-$MUSICDIR/$(ls "$MUSICDIR" | dmenu -i -p "Play ")}"
SCRIPT="$XDG_CONFIG_HOME/mpv/music/local.lua"

if [ "$MUSIC" = "$MUSICDIR/urls" ]; then
	MUSIC="$(cat "$MUSICDIR/urls/$(ls "$MUSICDIR/urls" | dmenu -i -p "Play ")")"
	SCRIPT="$XDG_CONFIG_HOME/mpv/music/online.lua"
fi

[ "$MUSIC" = "$XDG_MUSIC_DIR/" ] || [ -z "$MUSIC" ] && exit 1

if [ -d "$MUSIC" ] || [ -n "$(printf '%s' "$MUSIC" | awk /playlist/)" ]; then
	SHUFFLE="$(printf 'yes\nno' | dmenu -i -p 'Shuffle?')"
	[ -z "$SHUFFLE" ] && exit 1
fi

printf 'stop\n' | socat - /tmp/mpvsocket 2> /dev/null
mpv --vid=no --input-ipc-server=/tmp/mpvsocket --loop-playlist\
	--ytdl-format="wv*+ba" --script="$SCRIPT" --shuffle="$SHUFFLE" "$MUSIC"
