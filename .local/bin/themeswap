#!/bin/sh
# cycle between themes
# shellcheck disable=SC2046,SC2016

STATE=${XDG_STATE_HOME:-$HOME/.local/state}
CONF=${XDG_CONFIG_HOME:-$HOME/.config}

[ ! -f "$STATE/theme" ] &&
	true | dmenu -p "What theme are you currently using?" > "$STATE/theme" &&
	exit 0

case $(cat "$STATE/theme") in
gruvbox)
	theme=dracula
	bat=Dracula
	red="#ff5555"
	cyan="#8be9fd" ;;
dracula)
	theme=gruvbox
	bat=gruvbox-dark
	red="#cc241d"
	cyan="#689d6a" ;;
*)
	rm -f "$STATE/theme"
	exit 1 ;;
esac

echo "$theme" > "$STATE/theme"

# change theme
xrdb "$CONF/sx/$theme"
sed -i -e "s/^colorscheme.*/colorscheme $theme/"\
	-e "s/lualine.themes.*/lualine.themes.$theme'/"\
	"$CONF/nvim/appearance.vim"
sed -i -e "s/-sb '#.*-hf/-sb '$red' -hf/"\
	-e "s/-hf '#.*-/-hf '$cyan' -/"\
	"$HOME/.local/bin/dmenuoff"
sed -i -e "s/--theme.*/--theme=$bat/" "$CONF/bat/config"
sed -i -e "s/^THEME=.*/THEME=$bat/" "$CONF/lf/scope"
sed -i -e "s/^gtk-theme-name.*/gtk-theme-name=$theme/" "$CONF/gtk-3.0/settings.ini"
case $theme in
gruvbox)
	sed -i -e "s/^local colors =.*/local colors = require('$theme.palette').colors/"\
		-e 's/colors\./colors\.neutral_/g'\
		-e 's/neutral_black/dark0/'\
		"$CONF/nvim/appearance.vim" ;;
dracula)
	sed -i -e "s/^local colors =.*/local colors = require('$theme.palette')/"\
		-e 's/neutral_//g'\
		-e 's/dark0/black/'\
		"$CONF/nvim/appearance.vim" ;;
esac

# restart programs
kill -10 $(pidof dwm) $(pidof st)
for socket in /tmp/nvim.*.pipe; do
	nvim --server "$socket" --remote-send '<C-\><C-N>:source $MYVIMRC<CR>'
done
