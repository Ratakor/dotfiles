#!/bin/sh
# helper for the music script
# to force pause do: printf '{ "command": ["set_property", "pause", true] }\n' | socat - /tmp/mpvsocket 1> /dev/null

[ $(pgrep music) ] 2> /dev/null && notify-send "There is no music playing" && exit 1

CMD="${1:-$(printf 'â¯ï¸pause/play\nâ­ï¸next\nâ®ï¸prev\nðŸ“¢volume\nðŸ”³stop\nâ­favorite\nâ¬‡ï¸download\nðŸ–¼ï¸thumbnail' | dmenu -i -p "musiccmd")}"

strip() {
	tmp="${1##{\"data\":\"}"
	printf '%s\n' "${tmp%%\",\"request_id\":0,\"error\":\"success\"\}}"
}

stripvol() {
	tmp="${1##{\"data\":}"
	printf '%s\n' "${tmp%%.000000,\"request_id\":0,\"error\":\"success\"\}}"
}


getthumbnail() {
	path="$(strip "$(printf '{ "command": ["get_property", "path"] }\n'\
		| socat - /tmp/mpvsocket 2> /dev/null)")"

	case $path in
	*youtube.com*)
		yt-dlp --skip-download --force-overwrites --write-thumbnail\
			-o "$XDG_CACHE_HOME/thumbnail" "$path" > /dev/null 2>&1 &&\
			magick "$XDG_CACHE_HOME/thumbnail.webp" "$XDG_CACHE_HOME/thumbnail.jpg" ;;
	*)
		ffmpeg -y -i "$path" "$XDG_CACHE_HOME/thumbnail.jpg" 2> /dev/null ;;
	esac
}

download() {
	yt-dlp -f "ba" -x --embed-thumbnail --audio-format mp3 --postprocessor-args "-ar 44100"\
		-o"%(title)s [%(id)s].%(ext)s" -P "$1" "$2" || notify-send "I can't download, this is a local file"
}

addtofav() {
	path="$(strip "$(printf '{ "command": ["get_property", "path"] }\n'\
		| socat - /tmp/mpvsocket 2> /dev/null)")"

	case $path in
	*youtube.com*)
		download "$XDG_MUSIC_DIR/favorite" "$path" ;;
	*)
		cp "$path" "$XDG_MUSIC_DIR/favorite" ;;
	esac
}

case "$CMD" in
cycle|*pause|*play)
	printf 'cycle pause\n' | socat - /tmp/mpvsocket
	kill -43 "$(pidof dwmblocks)" ;;
*next)
	printf 'playlist-next\n' | socat - /tmp/mpvsocket ;;
*prev)
	printf 'playlist-prev\n' | socat - /tmp/mpvsocket ;;
*favorite)
	addtofav ;;
*volume)
	[ -z "$2" ] &&
		CURRENT="$(stripvol "$(printf '{ "command": ["get_property", "volume"] }\n'\
			| socat - /tmp/mpvsocket)")"

	printf '{ "command": ["set_property", "volume", %s] }\n'\
		"${2:-$(printf "" | dmenu -p "Current volume:$CURRENT")}"\
		| socat - /tmp/mpvsocket 1> /dev/null ;;
*stop)
	printf 'stop\n' | socat - /tmp/mpvsocket
	kill -43 "$(pidof dwmblocks)" ;;
*download)
	download "$XDG_MUSIC_DIR/download"\
		"$(strip "$(printf '{ "command": ["get_property", "path"] }\n'\
		| socat - /tmp/mpvsocket 2> /dev/null)")" ;;
*thumbnail)
	getthumbnail && sxiv "$XDG_CACHE_HOME/thumbnail.jpg" ;;
esac
