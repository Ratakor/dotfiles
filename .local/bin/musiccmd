#!/bin/sh
# helper for the music script
# to force pause do:
#printf '{ "command": ["set_property", "pause", true] }\n'\
#	| socat - /tmp/mpvsocket 1> /dev/null

if ! pgrep -x music >/dev/null; then
	kill -35 "$(pidof dwmblocks)"
	herbe "Error: There is no music playing" "Do you want to play some ?" &&
		music
 	exit 1
fi

CMD="${1:-$(printf '⏯️pause/play\n⏭️next\n⏮️prev\n📢volume\n🔳stop\n⭐favorite\n⬇️download\n🖼️thumbnail' | dmenu -i -p "musiccmd")}"
FAVDIR="${XDG_MUSIC_DIR:-$HOME/Music}/favorite"
DLDIR="${XDG_MUSIC_DIR:-$HOME/Music}/download"
CACHE="${XDG_CACHE_HOME:-$HOME/.cache}"

strip() {
	tmp="${1##{\"data\":\"}"
	printf '%s\n' "${tmp%%\",\"request_id\":0,\"error\":\"success\"\}}"
}

stripvol() {
	tmp="${1##{\"data\":}"
	printf '%s\n' "${tmp%%.000000,\"request_id\":0,\"error\":\"success\"\}}"
}

setpath() {
	path="$(strip "$(printf '{ "command": ["get_property", "path"] }\n'\
		| socat - /tmp/mpvsocket 2> /dev/null)")"
}

getthumbnail() {
	mkdir -p "$CACHE"
	case $path in
	*youtube.com*)
		yt-dlp --skip-download --force-overwrites --write-thumbnail\
			-o "$CACHE/thumbnail" "$path" > /dev/null 2>&1 &&\
			magick "$CACHE/thumbnail.webp" "$CACHE/thumbnail.jpg" ;;
	*)
		ffmpeg -y -i "$path" "$CACHE/thumbnail.jpg" 2> /dev/null ;;
	esac
}

download() {
	mkdir -p "$1"
	notify-send "Downloading '$2'"
	yt-dlp -f "ba" -x --embed-thumbnail --audio-format mp3\
		-o"%(title)s [%(id)s].%(ext)s" -P "$1" "$2" ||
		notify-send "Error: can't download, this is a local file"
}

addtofav() {
	case $path in
	*youtube.com*)
		download "$FAVDIR" "$path" ;;
	*)
		mkdir -p "$FAVDIR"
		cp "$path" "$FAVDIR" ;;
	esac
}

case "$CMD" in
cycle|*pause|*play)
	printf 'cycle pause\n' | socat - /tmp/mpvsocket
	kill -35 "$(pidof dwmblocks)" ;;
*next)
	printf 'playlist-next\n' | socat - /tmp/mpvsocket ;;
*prev)
	printf 'playlist-prev\n' | socat - /tmp/mpvsocket ;;
*favorite|fav)
	setpath
	addtofav ;;
*volume)
	[ -z "$2" ] &&
		current="$(stripvol "$(printf '{ "command": ["get_property", "volume"] }\n'\
			| socat - /tmp/mpvsocket)")"

	printf '{ "command": ["set_property", "volume", %s] }\n'\
		"${2:-$(printf "" | dmenu -p "Current volume:$current")}"\
		| socat - /tmp/mpvsocket 1> /dev/null ;;
*stop)
	printf 'stop\n' | socat - /tmp/mpvsocket
	kill -35 "$(pidof dwmblocks)" ;;
*download)
	setpath
	download "$DLDIR" "$path" &&
		notify-send "$path successfuly downloaded at '$DLDIR'" ;;
*thumbnail)
	setpath
	getthumbnail && nsxiv "$CACHE/thumbnail.jpg" ;;
path)
	setpath
	printf '%s\n' "$path" ;;
esac
