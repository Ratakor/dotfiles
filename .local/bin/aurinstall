#!/bin/sh
# install package from AUR

ROOTCMD="${ROOTCMD:-$(command -v doas || command -v sudo)}"
CACHE="${XDG_CACHE_HOME:-$HOME/.cache}/aur"

install() {
	git clone "https://aur.archlinux.org/$1.git" "$CACHE/$1"
	cd "$CACHE/$1" && makepkg -si
}

cleanup() {
	for package in "$@"; do
		rm -rf "$CACHE/$package"
	done
}

main() {
	[ -z "$*" ] &&
		printf "You must run this command with an argument\n" &&
		return 1

	mkdir -p "$CACHE"
	trap 'rm -rf "$CACHE/*"; exit 1' INT HUP QUIT TERM
	trap 'cleanup "$@"' EXIT

	for package in "$@"; do
		if pacman -Qq | grep -q -x "$package"; then
			printf '%s is already installed\nDo you want to update it ? (Y/n) ' "$package"
			read -r CHOICE
			case $CHOICE in
			"y"|"Y"|"yes"|"YES"|"Yes")
				install "$package" ;;
			*)
				continue ;;
			esac
		else
			install "$package"
		fi
	done
	if pacman -Qqdt 1>/dev/null; then
		printf "Type your password to remove orphaned packages\n"
		# shellcheck disable=SC2046
		"$ROOTCMD" pacman -Rns $(pacman -Qqdt)
	fi
}

main "$@"
